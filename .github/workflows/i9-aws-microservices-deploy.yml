name: üöÄ Deploy Backend - Arquitetura Distribu√≠da

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    name: Deploy Backend para EC2 Privada (via Bastion)
    runs-on: ubuntu-latest
    steps:
      - name: üîÅ Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üöÄ Deploy via SSH com ProxyJump
        uses: appleboy/ssh-action@v1.0.3
        with:
          proxy_host: ${{ secrets.REMOTE_HOST_PUBLIC }}
          proxy_username: ${{ secrets.REMOTE_USER }}
          proxy_key: ${{ secrets.EC2_SSH_KEY }}

          host: ${{ secrets.REMOTE_HOST_PRIVATE_APP }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          
          command_timeout: 30m

          script: |
            set -e # Para o script se houver erro

            # --- 1. Defini√ß√£o de Vari√°veis ---
            APP_DIR="/home/${{ secrets.REMOTE_USER }}/microservices"
            mkdir -p $APP_DIR
            cd $APP_DIR

            echo "üîµ Iniciando Deploy na EC2 Privada-3..."

            # Imagens Docker
            # DOCKER_TWILIO="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_TWILIO }}:latest"
            # DOCKER_JAVAMAIL="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_JAVAMAIL }}:latest"
            # DOCKER_IMAGES="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGES }}:latest"

            # --- 2. Garantir que a rede existe ---
            # Se a rede n√£o existir, cria ela para evitar erro no 'external: true'
            # if ! sudo docker network ls | grep -q "backend-app_app-network"; then
            #   echo "‚ö†Ô∏è Rede n√£o encontrada. Criando rede..."
            #   sudo docker network create backend-app_app-network
            # fi

            # --- 3. Criar Docker Compose Dinamicamente ---
            # NOTA: O conte√∫do abaixo deve estar alinhado √† esquerda para o YAML ser v√°lido
            cat <<EOF > docker-compose.yml
            version: '3.8'

            services:
              javamail:
                image: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_JAVAMAIL }}:latest
                restart: always
                environment:
                  SPRING_PROFILES_ACTIVE: dev
                  SPRING_DATASOURCE_USERNAME: ${{secrets.MYSQL_USER}}
                  SPRING_DATASOURCE_PASSWORD: ${{secrets.MYSQL_PASSWORD}}
                  SPRING_RABBITMQ_HOST: ${{secrets.RABBIT_JAVAMAIL_HOST}}
                  SPRING_RABBITMQ_PORT: 5672
                  SPRING_RABBITMQ_USERNAME: ${{secrets.RABBIT_JAVAMAIL_USERNAME}}
                  SPRING_RABBITMQ_PASSWORD: ${{secrets.RABBIT_JAVAMAIL_PASSWORD}}
                  SPRING_MAIL_USERNAME: ${{secrets.EMAIL_USER}}
                  SPRING_MAIL_PASSWORD: ${{secrets.EMAIL_PASSWORD}}
                  APP_FRONTEND_URL: ${{secrets.FRONTEND_URL}}
                networks:
                  - backend-app_app-network
                ports:
                  - "8086:8086"

              twilio:
                image: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_TWILIO }}:latest
                restart: always
                environment:
                  SPRING_PROFILES_ACTIVE: dev
                  SPRING_DATASOURCE_USERNAME: ${{secrets.MYSQL_USER}}
                  SPRING_DATASOURCE_PASSWORD: ${{secrets.MYSQL_PASSWORD}}
                  SPRING_RABBITMQ_HOST: ${{secrets.RABBIT_TWILIO_HOST}}
                  SPRING_RABBITMQ_PORT: 5672
                  SPRING_RABBITMQ_USERNAME: ${{secrets.RABBIT_TWILIO_USERNAME}}
                  SPRING_RABBITMQ_PASSWORD: ${{secrets.RABBIT_TWILIO_PASSWORD}}
                  TWILIO_ACCOUNT_SID: ${{secrets.TWILIO_SID}}
                  TWILIO_AUTH_TOKEN: ${{secrets.TWILIO_TOKEN}}
                  TWILIO_PHONE_NUMBER: ${{secrets.TWILIO_NUMBER}}
                networks:
                  - backend-app_app-network
                ports:
                  - "8087:8087"

              images:
                image: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGES }}:latest
                restart: always
                environment:
                  SPRING_PROFILES_ACTIVE: dev
                  SPRING_DATASOURCE_USERNAME: ${{secrets.MYSQL_USER}}
                  SPRING_DATASOURCE_PASSWORD: ${{secrets.MYSQL_PASSWORD}}
                  SPRING_RABBITMQ_HOST: ${{secrets.RABBIT_IMAGES_HOST}}
                  SPRING_RABBITMQ_PORT: 5672
                  SPRING_RABBITMQ_USERNAME: ${{secrets.RABBIT_IMAGES_USERNAME}}
                  SPRING_RABBITMQ_PASSWORD: ${{secrets.RABBIT_IMAGES_PASSWORD}}
                  STORAGE_S3_BUCKET_NAME: ${{secrets.S3_BUCKET_NAME}}
                  AWS_REGION: ${{secrets.S3_REGION}}
                  AWS_ACCESS_KEY_ID: ${{secrets.S3_ACCESS_KEY}}
                  AWS_SECRET_ACCESS_KEY: ${{secrets.S3_SECRET_KEY}}
                  AWS_SESSION_TOKEN: ${{secrets.S3_SECRET_TOKEN}}
                  AZURE_STORAGE_ACCOUNT_NAME: ${{secrets.AZ_ACCOUNT_NAME}}
                  STORAGE_AZURE_CONNECTION_STRING: ${{secrets.AZ_CONNECTION_STRING}}
                  STORAGE_AZURE_CONTAINER_NAME: ${{secrets.AZ_CONTAINER_NAME}}
                  AZURE_STORAGE_SAS_TOKEN: ${{secrets.AZ_SAS_TOKEN}}
                networks:
                  - backend-app_app-network
                ports:
                  - "8088:8088"

            networks:
              backend-app_app-network:
                external: true
            EOF

            echo "‚úÖ Docker Compose criado com sucesso."

            # --- 4. Login e Deploy ---
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | sudo docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            echo "‚¨áÔ∏è Baixando novas imagens..."
            sudo docker compose pull

            echo "üîÑ Reiniciando containers..."
            sudo docker compose down --remove-orphans || true
            sudo docker compose up -d

            echo "üöÄ Deploy finalizado na EC2 Privada-3!"